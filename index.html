<!doctype html><html><head>
  <meta charset=utf8>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
  <title>Rellotge analògic</title>
  <style>
    canvas.hora{
      border:1px solid black;
      background:lightblue;
      width:300px;
      height:300px;
      margin-top:1px;
    }
  </style>
</head><body><h1>Rellotge analògic</h1>

<div>
  <button
    onclick="dibuixa()"
    style="
      padding:10px 20px;
      width:302px;
    "
  >genera hora aleatòria</button>
</div>

<canvas class=hora></canvas>

<script>
  const W        = 300;//px amplada canvas
  const H        = 300;//px alçada canvas
  const RADI     = 100;//px radi rellotge
  const AGULLA_H = RADI*(2/(1+Math.sqrt(5))); //px llargada agulla hores | numero auric
  const AGULLA_M = RADI*0.95;                 //px llargada agulla minuts

  function genera_hora_aleatoria(){
    let hh = Math.floor(12*Math.random());
    let mm = Math.floor(12*Math.random())*5; //nomes de 5 en 5 minuts
    return {hh,mm};
  }

  function dibuixa_hora(hora,canvas){
    hora   = hora   || {hh:0,mm:0};
    canvas = canvas || document.querySelector('canvas');

    //força tamany canvas
    canvas.width  = W;
    canvas.height = H;

    //get context 2d i set font
    let c = canvas.getContext('2d');
    c.font = `18px Arial`;

    //dibuixa rodona
    c.beginPath();
    c.arc(W/2,H/2,RADI,0,2*Math.PI);
    c.closePath();
    c.lineWidth=1; //border width
    c.strokeStyle="black"; //border color
    c.stroke();
    c.fillStyle="lightyellow"; //color interior
    c.fill();

    //marca les hores (en text)
    [12,1,2,3,4,5,6,7,8,9,10,11].forEach(h=>{
      c.beginPath();
      let rad = -2*Math.PI*h/12 +Math.PI/2;
      let x = W/2 + Math.cos(rad)*RADI*0.75;
      let y = H/2 - Math.sin(rad)*RADI*0.75;
      c.moveTo(x,y);
      c.closePath();

      //text hora
      c.fillStyle="black";
      let text = h;
      let metrics = c.measureText(text);
      let height  = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
      c.fillText(text,x-metrics.width/2,y+height/2);
    });

    //dibuixa una ratlla per cada minut
    for(let i=0;i<60;i++){
      c.beginPath();

      let llargada = i%5==0 ? 0.85 : 0.95;

      let rad = -2*Math.PI*i/60 +Math.PI/2;
      let xi = W/2 + Math.cos(rad)*RADI*llargada;
      let yi = H/2 - Math.sin(rad)*RADI*llargada;
      c.moveTo(xi,yi);
      let xf = W/2 + Math.cos(rad)*RADI;
      let yf = H/2 - Math.sin(rad)*RADI;
      c.lineTo(xf,yf);
      c.closePath();

      c.lineWidth= i%5==0?2:1;
      c.strokeStyle="black";
      c.stroke();
    }

    //dibuixa agulla minuts
    c.beginPath();
    c.moveTo(W/2,H/2);
    {
      let rad = -2*Math.PI*hora.mm/60 +Math.PI/2;
      c.lineTo(
        W/2 + Math.cos(rad)*AGULLA_M,
        H/2 - Math.sin(rad)*AGULLA_M
      );
    }
    c.lineWidth=3.82;
    c.strokeStyle="red";
    c.stroke();
    c.closePath();

    //dibuixa agulla hores
    c.beginPath();
    c.moveTo(W/2,H/2);
    {
      let rad = -2*Math.PI*hora.hh/12 +Math.PI/2;

      //afegeix una mica més d'angle corresponent al minut
      rad -= (hora.mm/61)*(2*Math.PI/12);

      c.lineTo(
        W/2 + Math.cos(rad)*AGULLA_H,
        H/2 - Math.sin(rad)*AGULLA_H
      );
    }
    c.lineWidth=6.18;
    c.strokeStyle="blue";
    c.stroke();
    c.closePath();

    //dibuixa una mena de cargol al centre
    c.beginPath();
    c.arc(W/2,H/2,RADI*0.05,0,2*Math.PI);
    c.closePath();
    c.lineWidth=1; //border width
    c.strokeStyle="#aaa"; //border color
    c.stroke();
    c.fillStyle="#666"; //color interior
    c.fill();

    //escriu la hora en digital al canvas
    let h = hora.hh; //numero
    if(h==0) h=12;

    let text=`${h<10?'0'+h:h}:${hora.mm<10?'0'+hora.mm:hora.mm}`;
    let metrics = c.measureText(text);
    let height  = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
    c.fillStyle="black"; //color interior
    c.fillText(text,W/2-metrics.width/2,height+5);
  }

  function dibuixa(){
    let h = genera_hora_aleatoria();
    console.log(h);
    dibuixa_hora(h);
  }

  dibuixa();
</script>
